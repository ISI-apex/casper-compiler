include(casper)

# Input image
configure_file(casper-256x200.bmp casper.bmp COPYONLY)

# TODO: temporary: copy mocked up versions of files that should eventually be
# generated by the compiler.
set(MOCK_FILES
	halide_blur_i7_candidates.small.csv
	tf_models/model.pb
	tf_models/my-model.ckpt.data-00000-of-00001
	tf_models/my-model.ckpt.index
	tf_models/my-model.ckpt.meta)
foreach(mfile ${MOCK_FILES})
	configure_file(${mfile} ${mfile} COPYONLY)
endforeach()

casper_add_exec(blur blur.meta
  SOURCES blur.meta.cpp halide_kern.meta.cpp
  C_KERNEL_SOURCES kern.c
  PLATFORM platform.ini
  BUILD_DIR target

  TRAIN_ARGS
    --test-set-fraction=0.10
    --layers=2
    --features=6
    --tolerance=0.01
    --steps=10000

  # TODO: eventually these will be generated by the compilation flow
  # (i.e. will be intermediate artifacts not to be mentioned here.
  # Until then, we have mock artifacts, specified here.
  MODEL "tf_models/model.pb"
  MODEL_CP "tf_models/my-model.ckpt"
  CANDIDATES "halide_blur_i7_candidates.small.csv"
)

# Run the target program (test target)
add_custom_target(blur_run COMMAND target/blur DEPENDS target/blur)
